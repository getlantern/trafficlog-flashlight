# trafficlog-flashlight

A version of [trafficlog](github.com/getlantern/trafficlog) specifically tailored for use in [flashlight](github.com/getlantern/flashlight).

For context, the traffic log is used to watch traffic between the Flashlight client and the proxies. When the user reports an error, he or she may choose to attach packet captures generated by the traffic log. These will then be compared with packet captures from the proxies to diagnose issues and infer blocking patterns. The traffic log is only installed if permitted by the user.

The primary output of this repository is the tlproc package. This package is used by the Flashlight client to run the traffic log in a separate process. This is done so that we can grant packet-capture permissions exclusively to the traffic log process (and not the Flashlight client). The tlproc package also provides facilities for installing this traffic log on the user's machine. For more details on the tlproc package, please consult the Go doc.

# Project Structure

Currently, the flashlight client only interacts with the tlproc package. The tlproc package makes use of the more general trafficlog package to offer the functionality described above.

To achieve this functionality, tlproc makes use of binaries embedded in internal/tlserverbin. These binaries are written in Go and can be found in internal/cmd. Currently, these binaries are as follows:
 * tlserver   - the actual server run by the tlproc package
 * tlconfig   - used to configure the host when tlserver is installed
 * config-bpf - installed as a global daemon to configure the BPF devices on startup
  
For more information on each command, please refer to its Go doc.

# Building the Embedded Binaries

To embed the commands, we build each for the appropriate platform (currently only macOS), sign each, then package them up using [go-bindata](https://github.com/jteeuwen/go-bindata). We also include a 'debug' build of the tlserver binary which does not authenticate peer certificates (see the tlproc Go doc for more details). This is all handled in the Makefile and can be done by simply running `make`. Note that you will need the private key for the Lantern certificate in order to sign the binaries. To build only the (unsigned) debugging binaries, run `make debug`.

# Testing

To run the tests, call `make test`. The first time the tests are run on a host, a test-installation is performed in the tlproc directory. You will need to grant permissions for this. Subsequent tests will not need permissions. Your system BPF devices will be re-configured, but this should not have any adverse effects. Notably, the BPF devices are configured in a manner friendly to any existing Wireshark installations.

